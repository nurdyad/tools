# PasswordResetHelper.py

import secrets
import string
import os
from datetime import datetime
from playwright.sync_api import TimeoutError as PlaywrightTimeoutError


class PasswordResetHelper:

    @staticmethod
    def generate_secure_password(length=10):
        alphabet = string.ascii_letters + string.digits + "!@#$%^&*()"
        return ''.join(secrets.choice(alphabet) for _ in range(length))

    @staticmethod
    def handle_password_expiry_modal(browser, ods_code, Secrets, logger):
        logger.warning("Password expiry modal detected. Generating new password...")

        current_password = Secrets.get_docman_password(ods_code)
        new_password = PasswordResetHelper.generate_secure_password()

        # Fill in the modal form
        browser.fill("input#CurrentPassword", current_password)
        browser.fill("input#NewPassword", new_password)
        browser.fill("input#ConfirmPassword", new_password)
        browser.click("button:has-text('Change')")

        # Wait until we're logged in (modal gone)
        # 1. Save to Mailroom secrets (primary)
        try:
            Secrets.set_docman_password(ods_code, new_password)
            logger.info(f"[Docman] Password stored in Mailroom secrets for {ods_code}")
        except Exception as e:
            logger.error(f"[Docman] Failed to save password in Mailroom for {ods_code}: {e}")

        # 2. Always write to local file as backup (secondary)
        try:
            with open("output/docman_new_password.txt", "a") as f:
                timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
                f.write(f"[{timestamp}] {ods_code}: {new_password}\n")
            logger.warning("[Docman] Password saved to output/docman_new_password.txt")
        except Exception as e:
            logger.error(f"[Docman] Failed to write password to file: {e}")

        logger.info(f"[Docman] Password reset for {ods_code} completed successfully.")
        return new_password
